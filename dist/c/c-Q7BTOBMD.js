import{b as g,e as B}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-7CPACVX6.js";import{N as m,P as O,R as H,S as A,T as $,U as F}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-V2Q2Q5SX.js";import{q as M,r as ee}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-SEQO6JGA.js";import{a as P}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-CRBJZLYB.js";import{b as l,c as j}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-R72ZIPE6.js";import{a as R}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-LZBINVC2.js";import{b as I}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-MBCOPGYF.js";import{c as y,d as Z}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-4EBQPF62.js";import{a as L,c as T,d as a,e as C}from"https://st-p.rmcdn1.net/fb5a3d71/dist/c/c-ZYG7ZY5I.js";var x,te,D,X=L(()=>{"use strict";x=a(P()),te=x.default.Model.extend({idAttribute:"_id",urlRoot:"/api/folders/"}),D=x.default.Collection.extend({model:te,getByUri:function(e){return this.findWhere({uri:e})}})});var N,c,S,V,z=L(()=>{"use strict";N=a(P()),c=a(I());j();Z();B();S=a(R());F();V=N.default.Model.extend({idAttribute:"_id",url:function(){if(this.get("user")&&this.get("uri")){let t=this.get("user");c.default.isObject(t)&&(t=t.get("uri"));var e=t+"/"+this.get("uri")}else var e=this.getId();return"/api/readymag/"+e},PUBLISH_URL:"/api/publish/",UNPUBLISH_URL:"/api/unpublish/",parse:function(e){let{MagList:t}=(k(),C(q)),{UserModel:i}=(G(),C(W));return e.user&&(this.user=new i(e.user),delete e.user),e.title||(e.emptyTitle=!0),e.title=e.title||"Project",c.default.isEmpty(e.recentMags)||(this.recentMags=new t(e.recentMags,{parse:!0})),e},getPageNumId:function(e){if(!this.get("pages"))return"";let t=c.default.find(this.get("pages"),function(i){return i.num==e});return t?t.num_id:""},getPageId:function(e){if(!this.get("pages"))return"";let t=c.default.find(this.get("pages"),function(i){return i.num==e});return t?t._id:""},getPageScreenshot:function(e,t,i="default"){let s=c.default.findWhere(this.get("pages"),e),d=s?.viewport_phone_portrait?.enabled,o=s?.viewport_tablet_portrait?.enabled,u=i==="phone_portrait"&&d&&s?.viewport_phone_portrait?.screenshot,n=i==="tablet_portrait"&&o&&s?.viewport_tablet_portrait?.screenshot,f=u||n||s?.screenshot,Y=u?"half":"quarter",w=H(Y,u?"phone_portrait":n?"tablet_portrait":"default"),b=A.default,_=$(u?"phone_portrait":n?"tablet_portrait":"default",t);return e.specialScreenshot?{src:e.specialScreenshot,...b}:e.cover?!this.get("cover")&&this.get("pages")?this.getPageScreenshot({_id:this.get("coverPid")},t,i):this.get("cover")?{src:m(this.get("cover"),w),...b}:{src:`/api/screenshot/renew/${this.get("num_id")}/${this.get("coverPid")}/${this.get("is_published")?"ready":""}?viewport=${i}&redirect=true&size=${w}`,..._}:this.get("pages")?s&&s.unauthorized?{src:this.get("pass_bg")?this.get("pass_bg"):g("./viewer/mag-password/bg.jpg"),...b}:!f&&s?{src:`/api/screenshot/renew/${this.get("num_id")}/${s._id}/${this.get("is_published")?"ready":""}?viewport=${i}&redirect=true&size=${w}`,..._}:f&&!isNaN(Number(O(f)))?{src:f,..._}:{src:f&&m(f,w),..._}:(console.error("cannot find page screenshot: ",this,e),{src:void 0,...b})},getLink:function(){if(!y.isDesktop())return this.getUnpublishedViewerLink();let e=this.get("is_published")&&this.get("uri")||this.getId();return RM.common.customDomainProfile?"/"+e+"/":l.readymag_viewer_host+"/"+this.user.get("uri")+"/"+e+"/"},getUnpublishedViewerLink:function(){return l.readymag_auth_host+"/"+this.user.get("uri")+"/"+this.get("num_id")},getMagEditLink:function(){return l.readymag_auth_host+"/edit/"+this.getId()+"/"},getMagEditContentsLink:function(){return y.isDesktop()?this.getMagEditLink()+"contents/":this.getUnpublishedViewerLink()},getMagSettingsLink:function(){return this.getMagEditLink()+"settings/"},getId:function(){return this.get("num_id")},getPagesCount:function(){return this.get("pages_count")||this.get("pages")&&this.get("pages").length},deleteMag:function(e){this.deleteXHR&&this.deleteXHR.abort(),this.deleteXHR=S.default.ajax({type:"DELETE",url:"/api/mags/archive",data:JSON.stringify({mag_num_ids:[Number(this.getId())],folder_num_ids:[]}),contentType:"application/json; charset=utf-8",success:function(t){typeof e.success=="function"&&e.success(t)},error:function(t){console.log("Error deleting mag: "+t.responseText),this.onError("A problem occurred while deleting your project. Please, contact us: "+l.SUPPORT_MAIL)},context:this}).always(function(){typeof e.always=="function"&&e.always()})},_changePublishState:function(e,t){let i=e&&(e==="publish"||e==="republish")?this.PUBLISH_URL:this.UNPUBLISH_URL;this.publishXHR&&this.publishXHR.abort(),this.publishXHR=S.default.ajax({type:"POST",url:i+this.getId(),success:function(s){this.set("is_published",e&&e!=="unpublish"),e==="publish"&&(this.set("published",s.published||new Date().toISOString()),this.set("updated",s.updated||new Date().toISOString()),this.set("major_update",s.major_update||new Date().toISOString())),e==="republish"&&this.set(c.default.extend(c.default.omit(s,"user"),{updated:this.get("last_changed")})),this.set("coverPid",s.coverPid||this.get("coverPid")),this.set("cover",s.cover||this.get("cover")),typeof t.success=="function"&&t.success()},error:function(s){console.log("Error changing puplish state: "+s.responseText),this.onError("A problem occurred while "+e+"ing your project. Please, contact us: "+l.SUPPORT_MAIL)},context:this}).always(function(){typeof t.always=="function"&&t.always()})},publishMag:function(e){this._changePublishState("publish",e)},unpublishMag:function(e){this._changePublishState("unpublish",e)},republishMag:function(e){this._changePublishState("republish",e)},duplicateMag:function(e){let t="/api/mag/"+this.get("num_id")+"/duplicate",i;i={type:"POST",url:t,context:this},c.default.extend(i,e),this.duplicateXHR&&this.duplicateXHR.abort(),this.duplicateXHR=S.default.ajax(i)},hasUnsavedChanges:function(){return this.get("is_published")&&this.get("changed")},onError:function(e){alert(e)}})});var q={};T(q,{MagList:()=>p});var J,K,p,k=L(()=>{"use strict";J=a(P());z();K=a(R()),p=J.default.Collection.extend({model:V,load:function(e={}){let t=e.success||K.default.noop;this.loaded;let i=this;return e.success=function(){t(i),i.loaded=!0},this.fetch(e)},comparator:function(e){return-new Date(e.get("major_update")).getTime()}})});var W={};T(W,{UserModel:()=>U,UsersCollection:()=>Q,UsersLoader:()=>E,loadUser:()=>ie});var h,v,r,U,Q,E,ie,G=L(()=>{"use strict";h=a(R()),v=a(P()),r=a(I());j();ee();X();k();B();F();U=v.default.Model.extend({userpic_sizes:[64,96,128,192,256],mergePermissionsList:["can_publish"],idAttribute:"uri",url:"/api/me/",initialize:function(){r.default.bindAll(this)},store:function(e,t){(!e.name||/^\s$/.test(e.name))&&(e.name=this.get("name")),e=this.changedAttributes(e),this.set(e),this.validate(e)||h.default.ajax({type:"PUT",url:this.url,data:e,success:t&&typeof t.success=="function"&&t.success,error:t&&typeof t.error=="function"&&t.error})},deletePic:function(){let e=this;h.default.ajax({type:"DELETE",url:"/api/me/pic/",success:function(){e.set("pic","")}})},validate:function(e){if(e.name!==void 0&&r.default.isEmpty(h.default.trim(e.name)))return"Name yourself"},getUserpic:function(e){let t=this.get("pic"),i;return Modernizr.retina&&(e=e*2),e=r.default.find(this.userpic_sizes,function(s){return s>=e}),t?(t=m(t,e),t.indexOf("https://")==0||RM.common.isDownloadedSource||t.indexOf("/api/upload/")==-1&&(t="/api/upload/"+t),t):(i=this.get("name").match(/^[a-z0-9]{1}/i),i?g("./stubs/avatar/"+i[0].toLowerCase()+".gif"):g("./stubs/avatar/"+e+".gif"))},getLink:function(){let e=l.readymag_viewer_host;return RM.common.customDomainProfile?"/":RM.common.isDomainViewer?e+"/"+this.get("uri"):"/"+this.get("uri")},getWebsiteButified:function(){let e,t={link:"",label:""};return this.get("website")&&(e=M.URLParts(this.get("website")),e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path,t.label=e.hostname),t},getTwitterButified:function(){let e,t={link:"",nick:""};return this.get("twitter")&&(e=M.URLParts(this.get("twitter")),!e.protocol&&!e.path?(e.protocol="http://",t.nick=e.hostname,e.path="/"+t.nick,e.hostname="twitter.com"):(e.protocol=e.protocol||"http://",t.nick=e.path.split("/")[1]),t.link=e.protocol+e.hostname+e.path),t},getFacebookButified:function(){let e,t={link:"",nick:""};if(this.get("fb")){e=M.URLParts(this.get("fb"));try{e.path.indexOf("profile.php")!=-1?t.nick="facebook":e.path.split("/")[1]=="pages"?t.nick=decodeURIComponent(e.path.split("/")[2])||"":!e.protocol&&!e.path?(t.nick=e.hostname,e.hostname="facebook.com",e.path="/"+t.nick):t.nick=e.path.split("/")[1].split("?")[0]||"",e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path}catch(i){console.log("Error parsing FB URL: ",i)}}return t},mergePermissions:function(e){let t=r.default.clone(this.get("permissions"));this.set("permissions",e),r.default.each(this.mergePermissionsList,function(i){this.attributes.permissions[i]=this.attributes.permissions[i]&&t[i]},this)},resendConfirmationEmail:function(){h.default.get("/auth/confirm/resend")},isPublisher:function(){return this.get("permissions").can_publish},checkDomain:function(e,t){return h.default.ajax({type:"POST",url:"/api/checkdomain",data:{type:"user",domain:e},success:r.default.bind(function(i){this.set({last_checked_domain:e},{silent:!0}),t&&t(i)},this),error:r.default.bind(function(){console.error(arguments),t&&t(null)},this)})},mapDomain:function(e,t){return t=t||{},h.default.ajax({type:"POST",url:"/api/user/domain/",data:{domain:e,status:"on"},success:r.default.bind(function(i){this.set({domain:e},{silent:!0}),t.success&&t.success(i)},this),error:r.default.bind(function(i){return i&&i.status>=500?t.error(null):t.error&&t.error({badDNSSettings:!0})},this)})},unmapDomain:function(e){return h.default.ajax({type:"POST",url:"/api/user/domain/",data:{status:"off"},success:r.default.bind(function(t){this.unset("domain",{silent:!0}),e&&e(t)},this),error:r.default.bind(function(){console.error(arguments),e&&e(null)},this)})},isBetaTester:function(){return!!(this.get("permissions")||{}).can_use_beta_testing}}),Q=v.default.Collection.extend({model:U}),E=function(){this.allUsers=new Q,this.userMags={},this.userFolders={},r.default.bindAll(this)};E.prototype={LOAD_URL:"/api/readymags/user/",loadByUsername:function(e){var t,i;if(RM.common.customDomainProfile&&this.allUsers.at(0)){var t=this.allUsers.at(0),i=this.userMags[this.allUsers.at(0).get("uri")];return t.folders=this.userFolders[this.allUsers.at(0).get("uri")],e.success&&e.success({user:t,mags:i})}let s=this.allUsers.find(function(o){return o.get("uri").toLowerCase()==e.user_uri.toLowerCase()}),d=r.default.bind(function(o){let u,n;if(!o.user)return e.success({user:o});this.load(o,e.is_me),u=this.allUsers.get(o.user.uri),n=this.userMags[o.user.uri],u.folders=this.userFolders[o.user.uri],e.success&&e.success({user:u,mags:n})},this);s&&!e.force?(i=this.userMags[s.get("uri")],s.folders=this.userFolders[s.get("uri")],e.success({user:s,mags:i})):this.request(e.user_uri,{success:d,error:e.error})},load:function(e,t){let i;if(r.default.isEmpty(e))return;let s=e.user||e,d=e.mags,o=s.folders||[];if(s){i=s.uri,D&&(this.userFolders[i]=new D(o,{parse:!0}),delete s.folders),this.allUsers.remove(i),this.allUsers.add(s),t&&s.contributors&&r.default.each(s.contributors,function(n){n.member&&(n.member=new U(n.member))});let u=r.default.pick(s,"_id","uri","desc","pic");t&&(u.isMe=t),r.default.each(d,function(n){n.user=r.default.clone(u)}),p&&(this.userMags[i]=new p(d,{parse:!0}),t&&!r.default.isEmpty(d)&&this.userMags[i].each(function(n){n.user.set("isMe",!0)}))}},loadShared:function(e){r.default.isEmpty(e)||(this.sharedMags={},r.default.each(e,function(t){let i=r.default.pick(t.user,"_id","uri","desc","pic");r.default.each(t.mags,function(s){s.user=r.default.clone(i)}),this.sharedMags[t.user.uri.toLowerCase()]={user:new U(t.user),mags:new p(t.mags,{parse:!0})}},this))},request:function(e,t){RM.common.customDomainProfile&&(this.LOAD_URL="/api/domain/readymags/user/",e=""),t=t||{},this.abortLoading(),this.loadingXHR=h.default.ajax(r.default.extend(t,{type:"GET",url:this.LOAD_URL+e}))},abortLoading:function(){this.loadingXHR&&this.loadingXHR.abort&&this.loadingXHR.abort()}};ie=()=>{window.RM.data.usersLoader=new E;let e=window.ServerData.me;window.RM.data.usersLoader.load(e,!0),e?(e=e.user||e,e.uri&&(window.RM.data.usersLoader.me=window.RM.data.usersLoader.allUsers.get(e.uri))):window.RM.data.usersLoader.me=!1,window.ServerData.mags&&window.ServerData.mags.user&&window.ServerData.mags.mags&&(!window.RM.data.usersLoader.me||window.RM.data.usersLoader.me.get("uri")!==window.ServerData.mags.user.uri)&&window.RM.data.usersLoader.load(window.ServerData.mags),window.ServerData.shared&&window.RM.data.usersLoader.loadShared(window.ServerData.shared),r.default.isEmpty(window.ServerData.sharedError)||(window.RM.data.usersLoader.sharedError=window.ServerData.sharedError)}});export{V as a,z as b,U as c,Q as d,ie as e,G as f};
